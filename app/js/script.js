var fetchRedditData=function(t){var e=new XMLHttpRequest;e.open("get","http://www.reddit.com/r/earthporn/.json",!0),e.onload=function(a){t(JSON.parse(e.response).data.children)},e.send()},parseRedditData=function(t){var e=getDataForTopImage(t);clearLocalStorage(),setLocalStorageData(e),setStuff(settings(e))},getDataForTopImage=function(t){if(!t&&"object"==typeof t)throw"You didn't provide valid data to getDataForTopImage()!";var e={},a=!1;return t.forEach(function(t,o){isValidImagePost(t.data)&&!a&&filterDomain(t.data.domain)&&(console.log(t),e={author:t.data.author,bgUrl:t.data.url,created:t.data.created_utc,domain:t.data.domain,redditLink:"http://www.reddit.com"+t.data.permalink,title:stripSquareBrackets(t.data.title),score:t.data.score,subreddit:t.data.subreddit,url:t.data.url,timeSaved:Date.now()/1e3},a=!0)}),e},setStuff=function(t){console.log("setStuff called with this data:",t.data),t.setTitle(".pic-info-text"),t.setRedditLink([".js-score",".js-time-posted"]),t.setUserLink(".js-username"),t.setAuthor(".js-username"),t.setTimePosted(".js-time-posted"),t.setBackgroundImage(".main")},filterDomain=function(t){return"i.imgur.com"===t?!0:!1},settings=function(t){var e={data:t,setInnerHtml:function(t,e){var a=document.querySelector(t);a.innerHTML=e},setTitle:function(t){this.setInnerHtml(t,this.data.title)},setLink:function(t,e){var a=document.querySelector(t);a.href=e},setRedditLink:function(t){if("string"==typeof t)this.setLink(t,this.data.redditLink);else{if("undefined"==typeof t.length)throw"An invalid 'els' paramater was passed to this.setRedditLink. Please pass it a selector string or an array of selector strings.";for(i=0;i<t.length;i++)this.setLink(t[i],this.data.redditLink)}},setAuthor:function(t){this.setInnerHtml(t,this.data.author)},setUserLink:function(t){this.setLink(t,"http://www.reddit.com/user/"+this.data.author+"/")},setTimePosted:function(t){var e=(document.querySelector(t),Date.now()/1e3),a=this.data.created;this.setInnerHtml(t,Math.floor(getHrsDiff(a,e))+" hours ago")},setBackgroundImage:function(t){var e=document.querySelector(t);if(!this.data.base64Img&&!this.data.bgUrl)throw"Trying to set background, however could not find a base64Img or bgUrl in the data set!";this.data.base64Img?(e.style.backgroundImage="url("+this.data.base64Img+")",console.log("Using the base64!"),addClass(".main","main-visible")):(e.style.backgroundImage="url("+this.data.bgUrl+")",console.log("Using the img url!"),addClass(".main","main-visible"))}};return e},getImgurId=function(t){return t.substr(d.url.lastIndexOf("/")+1)},getHrsDiff=function(t,e){var a=e-t;return a/60/60},isLongerThanHrs=function(t,e){var a=getHrsDiff(t,Date.now()/1e3);return console.log("The time difference is: "+a+" hours"),a>e?!0:!1},clearLocalStorage=function(){chrome.storage.local.clear(function(){localStorage.clear(),console.log("Cleared localStorage!")})},setLocalStorageData=function(t){chrome.storage.local.set({oldData:t},function(){console.log("Saved settings to localStorage!"),convertImgToBase64URL(t.url,function(e){saveBase64ToLocalStorage(t,e)})})},saveBase64ToLocalStorage=function(t,e){var a=t;a.base64Img=e,chrome.storage.local.set({oldData:a},function(){console.log("Saved base64 image to localStorage!")})},isValidImagePost=function(t){return"self.EarthPorn"===t.domain||"AutoModerator"===t.author||"moderator"===t.distinguished?!1:!0},stripSquareBrackets=function(t){var e=t,a=e.lastIndexOf("[");if(a>0){var o=e.slice(a,e.length),n=e.replace(o,"");e=n.lastIndexOf("[")>0?stripSquareBrackets(n):n}return e},convertImgToBase64URL=function(t,e,a){var o=new Image;o.crossOrigin="Anonymous",o.onload=function(){var t,n=document.createElement("CANVAS"),r=n.getContext("2d");n.height=o.height,n.width=o.width,r.drawImage(o,0,0),t=n.toDataURL(a),e(t),n=null},o.src=t},setTime=function(t,e){var a=new Date,o=a.getHours(),n=a.getMinutes();10>n&&(n="0"+n);var r=o+":"+n;e!==r&&(document.querySelector(t).innerHTML=r);setTimeout(function(){setTime(t,r)},5e3)},addClass=function(t,e){var a=document.querySelector(t);a.classList.add(e)},removeClass=function(t,e){var a=document.querySelector(t);a.classList.remove(e)};document.addEventListener("DOMContentLoaded",function(t){setTime(".pic-info-time"),chrome.storage.local.get("oldData",function(t){if(t.oldData){var e=1;isLongerThanHrs(t.oldData.timeSaved,e)?(console.log("It's been longer than "+e+" hr(s)\nFetching new data!"),fetchRedditData(parseRedditData)):(console.log("It's been less than "+e+" hr(s)\nUsing old data!"),t.oldData.base64Img||convertImgToBase64URL(t.oldData.url,function(e){saveBase64ToLocalStorage(t.oldData,e)}),setStuff(settings(t.oldData)))}else fetchRedditData(parseRedditData)})});