var fetchRedditData=function(t,e){var s=new XMLHttpRequest;s.open("get","http://www.reddit.com/r/"+e+"/.json",!0),s.onload=function(e){t(JSON.parse(s.response).data.children)},s.send()},parseRedditData=function(t){var e=getDataForTopImage(t);clearLocalStorage(),setLocalStorageData(e),setStuff(GetData(e))},getDataForTopImage=function(t){if(!t&&"object"==typeof t)throw"You didn't provide valid data to getDataForTopImage()!";var e={},s=!1;return t.forEach(function(t,n){isValidImagePost(t.data)&&!s&&filterDomain(t.data.domain)&&(console.log(t),e={author:t.data.author,bgUrl:t.data.url,created:t.data.created_utc,domain:t.data.domain,redditLink:"http://www.reddit.com"+t.data.permalink,title:stripSquareBrackets(t.data.title),score:t.data.score,subreddit:t.data.subreddit,url:t.data.url,timeSaved:Date.now()/1e3},s=!0)}),e},setStuff=function(t){console.log("setStuff called with this data:",t.data),t.setTitle(".js-title"),t.setRedditLink([".js-score",".js-time-posted"]),t.setUserLink(".js-username"),t.setAuthor(".js-username"),t.setTimePosted(".js-time-posted"),t.setBackgroundImage(".js-img")},filterDomain=function(t){return"i.imgur.com"===t?!0:!1},getImgurId=function(t){return t.substr(d.url.lastIndexOf("/")+1)},getHrsDiff=function(t,e){var s=e-t;return s/60/60},isLongerThanHrs=function(t,e){var s=getHrsDiff(t,Date.now()/1e3);return console.log("The time difference is: "+s+" hours"),s>e?!0:!1},clearLocalStorage=function(){chrome.storage.local.clear(function(){localStorage.clear(),console.log("Cleared localStorage!")})},setLocalStorageData=function(t){chrome.storage.local.set({oldData:t},function(){console.log("Saved settings to localStorage!"),convertImgToBase64URL(t.url,function(e){saveBase64ToLocalStorage(t,e)})})},saveBase64ToLocalStorage=function(t,e){var s=t;s.base64Img=e,chrome.storage.local.set({oldData:s},function(){console.log("Saved base64 image to localStorage!")})},isValidImagePost=function(t){return"self.EarthPorn"===t.domain||"AutoModerator"===t.author||"moderator"===t.distinguished?!1:!0},stripSquareBrackets=function(t){var e=t,s=e.lastIndexOf("[");if(s>0){var n=e.slice(s,e.length),o=e.replace(n,"");e=o.lastIndexOf("[")>0?stripSquareBrackets(o):o}return e},convertImgToBase64URL=function(t,e,s){var n=new Image;n.crossOrigin="Anonymous",n.onload=function(){var t,o=document.createElement("CANVAS"),a=o.getContext("2d");o.height=n.height,o.width=n.width,a.drawImage(n,0,0),t=o.toDataURL(s),e(t),o=null},n.src=t},setupFlipEvent=function(t){var e=document.querySelector("."+t.el);e.addEventListener("click",function(){if(e.classList.contains(t.close))removeClass(e,t.close),addClass(e,t.open);else{if(!e.classList.contains(t.open))throw"What the whaaaa? http://bit.ly/1IjwmfN";removeClass(e,t.open),addClass(e,t.close)}})},setupToggleSettingsEvent=function(t){t.openSettings.addEventListener("click",function(){if(t.settings.classList.contains("settings-s-closed"))removeClass(".settings","settings-s-closed"),addClass(".settings","settings-s-open"),removeClass(t.openSettings,"settings-button-s-closed"),addClass(t.openSettings,"settings-button-s-open"),toggleContainerVisibility("close");else{if(!t.settings.classList.contains("settings-s-open"))throw"What the whaaaa? http://bit.ly/1IjwmfN";removeClass(".settings","settings-s-open"),addClass(".settings","settings-s-closed"),toggleContainerVisibility("open"),removeClass(t.openSettings,"settings-button-s-open"),addClass(t.openSettings,"settings-button-s-closed")}})},toggleContainerVisibility=function(t){if("string"!=typeof t)throw"toggleContainerVisibility() needs a string yo!";if("open"!==t&&"close"!==t)throw"You gotta pass 'open' or 'close' to toggleContainerVisibility()";var e=document.querySelector(".i-container"),s="i-container-s-visible",n="i-container-s-hidden";"close"===t&&e.classList.contains(s)&&(removeClass(e,s),addClass(e,n),setTimeout(function(){e.style.display="none"},500)),"open"===t&&e.classList.contains(n)&&(console.log("closing the settings, opening the "),e.style.display="block",setTimeout(function(){removeClass(e,n),addClass(e,s)},50))},setClock=function(t,e){var s=new Date,n=s.getHours(),o=s.getMinutes();10>o&&(o="0"+o);var a=n+":"+o;e!==a&&(document.querySelector(t).innerHTML=a);setTimeout(function(){setClock(t,a)},5e3)},addClass=function(t,e){var s;if("object"==typeof t)s=t;else{if("string"!=typeof t)throw"addClass() needs either an element or a selector string!";s=document.querySelector(t)}s.classList.add(e)},removeClass=function(t,e){var s;if("object"==typeof t)s=t;else{if("string"!=typeof t)throw"removeClass() needs either an element or a selector string!";s=document.querySelector(t)}s.classList.remove(e)},_log=function(t){console.log(t)},buildDefaultSettings=function(t){var e={updateFrequency:8,subs:[]};return t.forEach(function(t,s){var n="sub-"+t.toLowerCase();e.subs[s]={},e.subs[s].name=t,e.subs[s].subName=n,e.subs[s].active=!0,e.subs[s].html="<li class='settings-subreddit-list-item bg-'"+n+"><label class='settings-subreddit-label' for='"+n+"'><a class='settings-subreddit-label-link' href='http://www.reddit.com/r/"+t+"/'>"+t+"</a></label><input type='checkbox' class='settings-subreddit-checkbox' id='"+n+"' name='"+n+"' checked/></li>"}),e},parseSettings=function(t){setFrequency(t,".js-settings-update-frequency"),injectSubs(t,".js-settings-subs",showSettingsAvailable)},updateSettings=function(t,e){chrome.storage.local.set({settings:t},e)},injectSubs=function(t,e,s){var n;"string"==typeof e&&(n=document.querySelector(e)),"object"==typeof e&&(n=e),t.subs.forEach(function(t,e){}),s()},setFrequency=function(t,e){var s,n=t.updateFrequency;"string"==typeof e&&(s=document.querySelector(e)),"object"==typeof e&&(s=e),s.value=n},showSettingsAvailable=function(){},GetData=function(t){var e={data:t,setInnerHtml:function(t,e){var s=document.querySelector(t);s.innerHTML=e},setTitle:function(t){this.setInnerHtml(t,this.data.title)},setLink:function(t,e){var s=document.querySelector(t);s.href=e},setRedditLink:function(t){if("string"==typeof t)this.setLink(t,this.data.redditLink);else{if("undefined"==typeof t.length)throw"An invalid 'els' paramater was passed to this.setRedditLink. Please pass it a selector string or an array of selector strings.";for(i=0;i<t.length;i++)this.setLink(t[i],this.data.redditLink)}},setAuthor:function(t){this.setInnerHtml(t,this.data.author)},setUserLink:function(t){this.setLink(t,"http://www.reddit.com/user/"+this.data.author+"/")},setTimePosted:function(t){var e=(document.querySelector(t),Date.now()/1e3),s=this.data.created;this.setInnerHtml(t,Math.floor(getHrsDiff(s,e))+" hours ago")},setBackgroundImage:function(t){var e=document.querySelector(t);if(!this.data.base64Img&&!this.data.bgUrl)throw"Trying to set background, however could not find a base64Img or bgUrl in the data set!";this.data.base64Img?(document.styleSheets[1].addRule(t,"background-image: url("+this.data.base64Img+")"),console.log("Using the base64!"),addClass(".main","main-visible")):(e.style.backgroundImage="url("+this.data.bgUrl+")",console.log("Using the img url!"),addClass(".main","main-visible"))}};return e};document.addEventListener("DOMContentLoaded",function(t){setClock(".js-time"),setupFlipEvent({el:"js-flip-container",targetEl:"js-flip-container",open:"i-container-s-open",close:"i-container-s-closed"});var e={settings:document.querySelector(".settings"),openSettings:document.querySelector(".js-settings-controller")};setupToggleSettingsEvent(e),chrome.storage.local.get("oldData",function(t){if(t.oldData){var e=1;isLongerThanHrs(t.oldData.timeSaved,e)?(console.log("It's been longer than "+e+" hr(s)\nFetching new data!"),fetchRedditData(parseRedditData,"earthporn")):(console.log("It's been less than "+e+" hr(s)\nUsing old data!"),t.oldData.base64Img||convertImgToBase64URL(t.oldData.url,function(e){saveBase64ToLocalStorage(t.oldData,e)}),setStuff(GetData(t.oldData)))}else fetchRedditData(parseRedditData,"earthporn")}),chrome.storage.local.get("settings",function(t){if(t.settings)_log("Using old data for settings"),parseSettings(t.settings);else{var e=["EarthPorn","SkyPorn","WaterPorn","DesertPorn","WinerPorn","AutumnPorn","SpringPorn","SummerPorn","WeatherPorn","LakepPorn","SpacePorn"];_log("Using new data for settings");var s=buildDefaultSettings(e);updateSettings(s,function(){_log("Updated the settings!"),parseSettings(s)})}})});