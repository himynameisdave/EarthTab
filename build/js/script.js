var fetchRedditData=function(t,e){var s=new XMLHttpRequest;s.open("get","http://www.reddit.com/r/"+e+"/.json",!0),s.onload=function(e){t(JSON.parse(s.response).data.children)},s.send()},parseRedditData=function(t){var e=getDataForTopImage(t);removeItemFromLocalStorage("oldData"),setLocalStorageData(e),setStuff(GetData(e))},getDataForTopImage=function(t){if(!t&&"object"==typeof t)throw"You didn't provide valid data to getDataForTopImage()!";var e={},s=!1;return t.forEach(function(t,n){isValidImagePost(t.data)&&!s&&filterDomain(t.data.domain)&&(e={author:t.data.author,bgUrl:t.data.url,created:t.data.created_utc,domain:t.data.domain,redditLink:"http://www.reddit.com"+t.data.permalink,title:stripSquareBrackets(t.data.title),score:t.data.score,subreddit:t.data.subreddit,url:t.data.url,timeSaved:Date.now()/1e3},s=!0)}),e},setStuff=function(t){t.setTitle(".js-title"),t.setRedditLink([".js-score",".js-time-posted"]),t.setSubreddit(".js-subreddit"),t.setUserLink(".js-username"),t.setAuthor(".js-username"),t.setTimePosted(".js-time-posted"),t.setBackgroundImage(".js-img")},filterDomain=function(t){return"i.imgur.com"===t?!0:!1},getImgurId=function(t){return t.substr(d.url.lastIndexOf("/")+1)},getHrsDiff=function(t,e){var s=e-t;return s/60/60},isLongerThanHrs=function(t,e){var s=getHrsDiff(t,Date.now()/1e3);return s>e?!0:!1},clearLocalStorage=function(){chrome.storage.local.clear(function(){localStorage.clear()})},removeItemFromLocalStorage=function(t){chrome.storage.local.remove(t,function(){})},setLocalStorageData=function(t){chrome.storage.local.set({oldData:t},function(){convertImgToBase64URL(t.url,function(e){saveBase64ToLocalStorage(t,e)})})},saveBase64ToLocalStorage=function(t,e){var s=t;s.base64Img=e,chrome.storage.local.set({oldData:s},function(){})},isValidImagePost=function(t){return"self.EarthPorn"===t.domain||"AutoModerator"===t.author||"moderator"===t.distinguished?!1:!0},stripSquareBrackets=function(t){var e=t,s=e.lastIndexOf("[");if(s>0){var n=e.slice(s,e.length),i=e.replace(n,"");e=i.lastIndexOf("[")>0?stripSquareBrackets(i):i}return e},convertImgToBase64URL=function(t,e,s){var n=new Image;n.crossOrigin="Anonymous",n.onload=function(){var t,i=document.createElement("CANVAS"),a=i.getContext("2d");i.height=n.height,i.width=n.width,a.drawImage(n,0,0),t=i.toDataURL(s),e(t),i=null},n.src=t},setupFlipEvent=function(t){var e=document.querySelector("."+t.el);e.addEventListener("click",function(){if(e.classList.contains(t.close))removeClass(e,t.close),addClass(e,t.open);else{if(!e.classList.contains(t.open))throw"What the whaaaa? http://bit.ly/1IjwmfN";removeClass(e,t.open),addClass(e,t.close)}})},setupToggleSettingsEvent=function(t){t.openSettings.addEventListener("click",function(){if(t.settings.classList.contains("settings-s-closed"))removeClass(".settings","settings-s-closed"),addClass(".settings","settings-s-open"),removeClass(t.openSettings,"settings-button-s-closed"),addClass(t.openSettings,"settings-button-s-open"),toggleContainerVisibility("close");else{if(!t.settings.classList.contains("settings-s-open"))throw"What the whaaaa? http://bit.ly/1IjwmfN";removeClass(".settings","settings-s-open"),addClass(".settings","settings-s-closed"),toggleContainerVisibility("open"),removeClass(t.openSettings,"settings-button-s-open"),addClass(t.openSettings,"settings-button-s-closed")}})},toggleContainerVisibility=function(t){if("string"!=typeof t)throw"toggleContainerVisibility() needs a string yo!";if("open"!==t&&"close"!==t)throw"You gotta pass 'open' or 'close' to toggleContainerVisibility()";var e=document.querySelector(".i-container"),s="i-container-s-visible",n="i-container-s-hidden";"close"===t&&e.classList.contains(s)&&(removeClass(e,s),addClass(e,n),setTimeout(function(){e.style.display="none"},500)),"open"===t&&e.classList.contains(n)&&(e.style.display="block",setTimeout(function(){removeClass(e,n),addClass(e,s)},50))},setClock=function(t,e){var s=new Date,n=s.getHours(),i=s.getMinutes();10>i&&(i="0"+i),n>12&&(n-=12);var a=n+":"+i;e!==a&&(document.querySelector(t).innerHTML=a);setTimeout(function(){setClock(t,a)},5e3)},truncatePostTime=function(t){var e,s;return 24>t?(e=Math.floor(t),s=e>1?" hrs":" hr",e+s):t>=24&&168>t?(e=Math.floor(t/24),s=e>1?" days":" day",e+s):t>=168?(e=Math.floor(t/168),s=e>1?" weeks":" week",e+s):void 0},resolveElement=function(t){var e;if("string"==typeof t)e=document.querySelector(t);else{if("object"!=typeof t)throw"Not a real element!\nPlease pass either a selector string or element object!";e=t}return e},addClass=function(t,e){var s;if("object"==typeof t)s=t;else{if("string"!=typeof t)throw"addClass() needs either an element or a selector string!";s=document.querySelector(t)}s.classList.add(e)},removeClass=function(t,e){var s;if("object"==typeof t)s=t;else{if("string"!=typeof t)throw"removeClass() needs either an element or a selector string!";s=document.querySelector(t)}s.classList.remove(e)},GetSettings=function(){return{Settings:{},subList:["EarthPorn","SkyPorn","WaterPorn","DesertPorn","WinterPorn","AutumnPorn","SpringPorn","SummerPorn","WeatherPorn","LakePorn","SpacePorn"],finishedInit:!1,init:function(){var t=this;this.fetchOldSettings(function(e){if(e.settings)t.Settings=e.settings,t.parseSettings(),t.finishedInit=!0;else{var s=t.buildDefaultSettings();t.updateSettings(s,function(e){t.Settings=s,t.parseSettings(),t.finishedInit=!0})}})},fetchOldSettings:function(t){chrome.storage.local.get("settings",t)},updateSettings:function(t,e){chrome.storage.local.set({settings:t},e)},parseSettings:function(){this.setFrequency(this.Settings.updateFrequency,".js-settings-update-frequency"),this.injectSubs(".js-settings-subs"),this.setupFrequencyChangeListener(".js-settings-update-frequency"),this.setupCheckboxChangeListener()},buildDefaultSettings:function(){var t={updateFrequency:8,subs:[]},e=this;return this.subList.forEach(function(s,n){var i="sub-"+s.toLowerCase();t.subs[n]={},t.subs[n].name=s,t.subs[n].subName=i,t.subs[n].active=!0,t.subs[n].html=e.generateSubListItemHtml(t.subs[n])}),t},generateSubListItemHtml:function(t){var e=t.subName,s=t.name,n=t.active,i="";return i+="<li class='settings-subreddit-list-item bg-"+e+"'>",i+="<label class='settings-subreddit-label' for='"+e+"'>",i+="<a class='settings-subreddit-label-link' href='http://www.reddit.com/r/"+s+"/'>"+s+"</a>",i+="</label>",i+="<input type='checkbox' class='settings-subreddit-checkbox' id='"+e+"' name='"+e+"'",n&&(i+=" checked"),i+=" /></li>"},injectSubs:function(t,e){var s=resolveElement(t),n="";this.Settings.subs.forEach(function(t,e){n+=t.html}),s.innerHTML=n,e&&e()},convertFrequencyToHrs:function(t){return.25*t},setFrequency:function(t,e,s){var n=resolveElement(e),i=".js-settings-update-frequency::-webkit-slider-thumb:before";n.value=t;var a=this.convertFrequencyToHrs(t);document.styleSheets[1].addRule(i,"content: '"+a+"'"),s&&s()},setupFrequencyChangeListener:function(t){var e=resolveElement(t),s=!1,n=this;e.addEventListener("input",function(){var i=parseInt(e.value);s||(s=!0,n.setFrequency(i,t,function(){s=!1}),n.Settings.updateFrequency=e.value,n.showSaveSettings(),n.updateSettings(n.Settings,function(){}))})},setupCheckboxChangeListener:function(){var t=this;this.subList.forEach(function(e,s){var n=document.querySelector("#sub-"+e.toLowerCase());n.addEventListener("change",function(){var s,i=n.checked,a=e;t.Settings.subs.forEach(function(t,e){t.name===a&&(s=e)}),t.Settings.subs[s].active=i,t.Settings.subs[s].html=t.generateSubListItemHtml(t.Settings.subs[s]),t.showSaveSettings(),t.updateSettings(t.Settings,function(){})})})},isSaveAlertVisible:!1,settingsAlertShowTime:1250,settingsAlertEl:document.querySelector(".settings-saved-alert"),showSaveSettings:function(){if(!this.isSaveAlertVisible){var t="settings-saved-alert-s-hidden",e="settings-saved-alert-s-visible",s=this;this.settingsAlertEl.classList.contains(t)&&removeClass(this.settingsAlertEl,t),addClass(this.settingsAlertEl,e),this.isSaveAlertVisible=!0,setTimeout(function(){s.settingsAlertEl.classList.contains(e)&&(removeClass(s.settingsAlertEl,e),addClass(s.settingsAlertEl,t)),s.isSaveAlertVisible=!1},s.settingsAlertShowTime)}},gimmieARandomActiveSub:function(){var t=[];this.Settings.subs.forEach(function(e,s){e.active&&t.push(e.name)});var e=Math.floor(Math.random()*t.length);return t[e]}}},GetData=function(t){var e={data:t,setInnerHtml:function(t,e){var s=document.querySelector(t);s.innerHTML=e},setTitle:function(t){this.setInnerHtml(t,this.data.title)},setLink:function(t,e){var s=document.querySelector(t);s.href=e},setRedditLink:function(t){if("string"==typeof t)this.setLink(t,this.data.redditLink);else{if("undefined"==typeof t.length)throw"An invalid 'els' paramater was passed to this.setRedditLink. Please pass it a selector string or an array of selector strings.";for(i=0;i<t.length;i++)this.setLink(t[i],this.data.redditLink)}},setSubreddit:function(t){this.setInnerHtml(t,this.data.subreddit),this.setLink(t,"http://www.reddit.com/r/"+this.data.subreddit)},setAuthor:function(t){this.setInnerHtml(t,this.data.author)},setUserLink:function(t){this.setLink(t,"http://www.reddit.com/user/"+this.data.author+"/")},setTimePosted:function(t){var e=(document.querySelector(t),Date.now()/1e3),s=this.data.created;this.setInnerHtml(t,truncatePostTime(getHrsDiff(s,e))+" ago")},setBackgroundImage:function(t){var e=document.querySelector(t);if(!this.data.base64Img&&!this.data.bgUrl)throw"Trying to set background, however could not find a base64Img or bgUrl in the data set!";this.data.base64Img?(document.styleSheets[1].addRule(t,"background-image: url("+this.data.base64Img+")"),addClass(".main","main-visible")):(e.style.backgroundImage="url("+this.data.bgUrl+")",addClass(".main","main-visible"))}};return e},$ettings;document.addEventListener("DOMContentLoaded",function(t){setClock(".js-time"),$ettings=GetSettings(),$ettings.init(),setupFlipEvent({el:"js-flip-container",targetEl:"js-flip-container",open:"i-container-s-open",close:"i-container-s-closed"});var e={settings:document.querySelector(".settings"),openSettings:document.querySelector(".js-settings-controller")};setupToggleSettingsEvent(e),chrome.storage.local.get("oldData",function(t){var e,s;if(t.oldData){if(!$ettings.Settings)throw"$ettings.Settings was not available when we looked for it!";s=.25*$ettings.Settings.updateFrequency,isLongerThanHrs(t.oldData.timeSaved,s)?(e=$ettings.gimmieARandomActiveSub().toLowerCase(),fetchRedditData(parseRedditData,e)):(t.oldData.base64Img||convertImgToBase64URL(t.oldData.url,function(e){saveBase64ToLocalStorage(t.oldData,e)}),setStuff(GetData(t.oldData)))}else if($ettings.finishedInit)e=$ettings.gimmieARandomActiveSub().toLowerCase(),fetchRedditData(parseRedditData,e);else var n=setInterval(function(){$ettings.finishedInit&&(e=$ettings.gimmieARandomActiveSub().toLowerCase(),fetchRedditData(parseRedditData,e)),clearInterval(n)},100)})});